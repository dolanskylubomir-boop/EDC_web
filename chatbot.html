<!-- chatbot.html – FINÁLNÍ VERZE -->

<div class="tereza-wrapper">
    <div class="tereza-pulse-ring"></div>
    <div class="tereza-toggle">
        <img src="https://images.unsplash.com/photo-1494790108377-be9c29b29330?w=140&h=140&fit=crop&crop=face" alt="Terezka">
    </div>
</div>

<div id="tereza-chat" class="tereza-modern">
    <div class="tereza-header">
        <div class="tereza-info">
            <img src="https://images.unsplash.com/photo-1494790108377-be9c29b29330?w=100&h=100&fit=crop&crop=face" alt="Terezka">
            <div>
                <div class="tereza-name">Terezka</div>
                <div class="tereza-status">Online • EDC Asistentka</div>
            </div>
        </div>
        <div class="tereza-actions">
            <button class="tereza-newchat" title="Nový chat">↺</button>
            <button class="tereza-close">×</button>
        </div>
    </div>

    <div class="tereza-sidebar">
        <div class="tereza-title">Rychlé odkazy</div>
        <div class="tereza-item" data-q="Co je EDC?">O společnosti</div>
        <div class="tereza-item" data-q="Jaké jsou kontakty na EDC?">Kontakty a sídlo</div>
        <div class="tereza-item" data-q="Co je sdílení energie v komunitě?">Komunitní energetika</div>
        <div class="tereza-item" data-q="Jak fungují videonávody ke sdílení?">Video návody</div>
        <div class="tereza-item" data-q="Kde najdu dokumenty ke sdílení?">Dokumenty</div>
        <div class="tereza-item" data-q="FAQ ke sdílení elektřiny">FAQ</div>
    </div>

    <div class="tereza-content">
        <div id="tereza-messages" class="tereza-messages"></div>
        <div id="tereza-typing" class="tereza-typing"><span></span><span></span><span></span></div>
        <div class="tereza-input">
            <input type="text" id="tereza-input" placeholder="Napište zprávu…" autocomplete="off">
            <button id="tereza-send">
                <svg viewBox="0 0 24 24">
                    <path fill="currentColor" d="M2,21L23,12L2,3V10L17,12L2,14V21Z"/>
                </svg>
            </button>
        </div>
    </div>
</div>

<script>
(function () {
    if (window.__TEREZA_INIT__) return;
    window.__TEREZA_INIT__ = true;

    const API_KEY = "AIzaSyBqPX2JXtqjrLNwAUbq1bg6KPPJSgzszWE";

    const welcomeMessage = {
        role: 'model',
        parts: [{ text: 'Vítejte! Jsem Terezka, vaše virtuální asistentka EDC. Jak vám dnes mohu pomoci?' }]
    };

    let messages = [welcomeMessage];

    const saved = localStorage.getItem('terezaMessages');
    if (saved) {
        try {
            const parsed = JSON.parse(saved);
            if (Array.isArray(parsed)) messages = parsed;
        } catch {}
    }

    function renderMessages() {
        const box = document.getElementById('tereza-messages');
        box.innerHTML = '';
        messages.forEach(m => {
            if (m.role === 'model') {
                box.insertAdjacentHTML('beforeend', `
                    <div class="tereza-bot">
                        <img src="https://images.unsplash.com/photo-1494790108377-be9c29b29330?w=80&h=80&fit=crop&crop=face">
                        <div class="tereza-bubble">${m.parts[0].text}</div>
                    </div>
                `);
            } else {
                box.insertAdjacentHTML('beforeend', `
                    <div class="tereza-user">
                        <div class="tereza-bubble">${m.parts[0].text}</div>
                    </div>
                `);
            }
        });
        box.scrollTop = 99999;
    }

    renderMessages();

    function startNewChat() {
        messages = [welcomeMessage];
        localStorage.removeItem('terezaMessages');
        renderMessages();
    }

    function openSection(file) {
        if (window.loadContent) window.loadContent(file);
    }

    function handleLocalIntents(msg) {
        const l = msg.toLowerCase();

        if (l.includes('video')) {
            addBot('Otevřela jsem stránku s video návody.');
            openSection('sdileni_video_content.html');
            return true;
        }

        if (l.includes('dokument')) {
            addBot('Otevřela jsem stránku s dokumenty.');
            openSection('sdileni_dokumenty_content.html');
            return true;
        }

        if (l.includes('faq')) {
            addBot('Otevřela jsem stránku s FAQ.');
            openSection('sdileni_FAQ_content.html');
            return true;
        }

        if (l.includes('sdílení') || l.includes('sdileni')) {
            addBot('Otevřela jsem stránku o sdílení elektřiny.');
            openSection('sdileni_content.html');
            return true;
        }

        return false;
    }

    function addBot(text) {
        messages.push({ role: 'model', parts: [{ text }] });
        localStorage.setItem('terezaMessages', JSON.stringify(messages));
        renderMessages();
    }

    async function send() {
        const input = document.getElementById('tereza-input');
        const msg = input.value.trim();
        if (!msg) return;
        input.value = '';

        messages.push({ role: 'user', parts: [{ text: msg }] });
        renderMessages();

        if (handleLocalIntents(msg)) return;

        document.getElementById('tereza-typing').style.display = 'flex';

        try {
            const r = await fetch(
                `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${API_KEY}`,
                {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: messages })
                }
            );
            const d = await r.json();
            const reply = d.candidates[0].content.parts[0].text;
            addBot(reply);
        } catch {
            addBot('Omlouvám se, došlo k chybě.');
        } finally {
            document.getElementById('tereza-typing').style.display = 'none';
        }
    }

    document.querySelector('.tereza-toggle').onclick = () =>
        document.getElementById('tereza-chat').classList.toggle('open');

    document.querySelector('.tereza-close').onclick = () =>
        document.getElementById('tereza-chat').classList.remove('open');

    document.querySelector('.tereza-newchat').onclick = startNewChat;

    document.querySelectorAll('.tereza-item').forEach(i =>
        i.onclick = () => {
            document.getElementById('tereza-input').value = i.dataset.q;
            send();
        }
    );

    document.getElementById('tereza-send').onclick = send;
    document.getElementById('tereza-input').addEventListener('keydown', e => e.key === 'Enter' && send());
})();
</script>
